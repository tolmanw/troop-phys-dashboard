<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Strava Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<style>
/* ===============================
   FIX: Prevent daily chart crashing
   =============================== */
.daily-chart-wrapper {
    height: 200px;
    overflow: hidden;
}
.daily-chart-wrapper canvas {
    height: 100% !important;
}

/* Optional polishing (matches your existing look) */
.card {
    background: white;
    border-radius: 12px;
    padding: 1.25rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
</style>
</head>
<body class="bg-gray-100">

<div class="max-w-6xl mx-auto p-6">

    <!-- Title -->
    <h1 class="text-3xl font-bold mb-6">Strava Monthly Dashboard</h1>

    <!-- Activity Filter -->
    <div class="mb-6">
        <label class="font-semibold">Filter by Activity Type:</label>
        <select id="activityFilter" class="border rounded p-2 ml-2">
            <option value="All">All</option>
        </select>
    </div>

    <!-- Athletes Container -->
    <div id="athleteContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6"></div>

</div>


<script>
// ===============================
// Load JSON
// ===============================
fetch("data/athletes.json")
  .then(r => r.json())
  .then(data => initDashboard(data));

let charts = {};

function initDashboard(data) {
    const athletes = data.athletes;
    const monthNames = data.month_names;

    // Populate activity filter dropdown
    const activitySet = new Set();
    Object.values(athletes).forEach(a => {
        (a.activity_types || []).forEach(t => activitySet.add(t));
    });

    const filterSelect = document.getElementById("activityFilter");
    [...activitySet].sort().forEach(act => {
        const opt = document.createElement("option");
        opt.value = act;
        opt.textContent = act;
        filterSelect.appendChild(opt);
    });

    filterSelect.addEventListener("change", () => {
        renderAthletes(athletes, monthNames);
    });

    renderAthletes(athletes, monthNames);
}


// ===============================
// Render Athletes
// ===============================
function renderAthletes(athletes, monthNames) {
    const container = document.getElementById("athleteContainer");
    container.innerHTML = "";
    const activityFilter = document.getElementById("activityFilter").value;

    Object.entries(athletes).forEach(([username, athlete]) => {

        // FIX: Filtering based on updated JSON field
        if (activityFilter !== "All" &&
            !athlete.activity_types.includes(activityFilter)) {
            return;
        }

        const card = document.createElement("div");
        card.className = "card";

        // Header
        card.innerHTML = `
            <div class="flex items-center mb-4">
                <img src="${athlete.profile}" class="w-14 h-14 rounded-full mr-3">
                <div>
                    <h2 class="text-xl font-semibold">${athlete.firstname} ${athlete.lastname}</h2>
                    <div class="text-gray-500">@${athlete.username}</div>
                </div>
            </div>

            <div class="mb-4 font-semibold">${monthNames.join(" â€¢ ")}</div>

            <!-- Monthly Distance Chart -->
            <canvas id="monthlyChart-${username}" height="120"></canvas>

            <div class="mt-6 mb-2 font-semibold">Daily Distance</div>

            <!-- FIXED wrapper to prevent expansion -->
            <div class="daily-chart-wrapper">
                <canvas id="dailyChart-${username}"></canvas>
            </div>
        `;

        container.appendChild(card);

        drawMonthlyChart(username, athlete, monthNames);
        drawDailyChart(username, athlete);
    });
}


// ===============================
// Monthly Chart
// ===============================
function drawMonthlyChart(username, athlete, monthNames) {
    const id = `monthlyChart-${username}`;
    if (charts[id]) charts[id].destroy();

    charts[id] = new Chart(document.getElementById(id), {
        type: 'bar',
        data: {
            labels: monthNames,
            datasets: [{
                label: "Distance (km)",
                data: athlete.monthly_distances,
                backgroundColor: "rgba(54,162,235,0.6)",
                borderColor: "rgba(54,162,235,1)",
                borderWidth: 1,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
        }
    });
}


// ===============================
// Daily Chart (FIXED HEIGHT)
// ===============================
function drawDailyChart(username, athlete) {
    const id = `dailyChart-${username}`;
    if (charts[id]) charts[id].destroy();

    // Flatten all days across all months
    const daily = athlete.daily_distance_km.flat();
    const labels = daily.map((_, i) => i + 1);

    charts[id] = new Chart(document.getElementById(id), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: "KM per day",
                data: daily,
                fill: false,
                borderWidth: 2,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // required but safe due to wrapper
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

</script>

</body>
</html>
